
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Loading...</title>
  <style>
    body {
      background-color: #000;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: sans-serif;
    }

    .spinner {
      margin-top: 20px;
      width: 50px;
      height: 50px;
      border: 6px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    p {
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <p>Processing your submission...</p>
  <div class="spinner"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const submissionId = urlParams.get('submission_id');

    const maxRetries = 20;
    const delay = 3000; // 3 seconds

    let attempt = 0;

    async function checkStatus() {
      attempt++;

      try {
        const response = await fetch("https://calm-crisp-c58e08.netlify.app/redirect_map.csv");
        const csvText = await response.text();

        const rows = csvText.split("\n").map(row => row.split(","));
        const headers = rows[0];
        const submissionIndex = headers.indexOf("submission_id");
        const fileIdIndex = headers.indexOf("file_id");

        const matchingRow = rows.find(row => row[submissionIndex] === submissionId);

        if (matchingRow && matchingRow[fileIdIndex] && matchingRow[fileIdIndex] !== "PENDING") {
          const fileId = matchingRow[fileIdIndex].trim();
          const redirectUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
          window.location.href = redirectUrl;
          return;
        }
      } catch (error) {
        console.error("Error checking redirect map:", error);
      }

      if (attempt < maxRetries) {
        setTimeout(checkStatus, delay);
      } else {
        window.location.href = "/come-back-later.html";
      }
    }

    checkStatus();
  </script>
</body>
</html>
