<script>
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get("id");

  async function tryFetchRedirect(maxRetries = 15, delayMs = 3000) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        const response = await fetch(`/public/orders/${id}.json?_=${Date.now()}`); // prevent cache

        if (response.ok) {
          const data = await response.json();
          if (data.redirect_url) {
            window.location.href = data.redirect_url;
            return;
          } else {
            throw new Error("Redirect URL not found.");
          }
        } else {
          throw new Error("File not found.");
        }
      } catch (err) {
        console.log(`Attempt ${attempt} failed: ${err.message}`);
        if (attempt === maxRetries) {
          document.body.innerText = "Still processing your order. Please try again shortly.";
          return;
        }
        await new Promise((res) => setTimeout(res, delayMs));
      }
    }
  }

  if (!id) {
    document.body.innerText = "Missing ID.";
  } else {
    tryFetchRedirect();
  }
</script>
